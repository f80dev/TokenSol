<div class="mainform">

  <div class="titleform">Minage des NFTs</div>
  <div class="subtitleform">
    Minage sur {{network.network}} prévu pour {{tokens.length}} NFTs assuré par {{user.key?.name}}
  </div>


<div *ngIf="user.advance_mode" style="display: flex;justify-content: stretch;align-content: stretch;">
  <mat-expansion-panel style="margin:10px;" >
    <mat-expansion-panel-header>Traitement en masse</mat-expansion-panel-header>
    <a href="./assets/Assets.xlsm">Fichier De traitement en masse</a><br><br>

    <app-upload-file (uploaded)="batch_import($event)"
                     width="100px"
                     extensions=".xlsx,.xls,.csv">
      Importer
    </app-upload-file>

    <button type="button" mat-button mat-raised-button
            [cdkCopyToClipboard]="nfts_to_clipboard()"
            title="Copier la liste des NFT à miner dans le presse-papier"
            (click)="confirm_clipboard()">
      Exporter pour Opération
    </button>
  </mat-expansion-panel>

  <mat-expansion-panel style="margin:10px;" *ngIf="user.advance_mode">
    <mat-expansion-panel-header>Propriétés avancée</mat-expansion-panel-header>
    <div id="command_panel" style="display: inline-block;margin:10px;" *ngIf="tokens.length>0">
      <!--    <mat-checkbox [(ngModel)]="sign">Signer</mat-checkbox>-->

      <mat-checkbox *ngFor="let create_option of create_options" [(ngModel)]="create_option.value" style="margin: 10px;">
        {{create_option.label}}
      </mat-checkbox>

    </div>

  </mat-expansion-panel>

  <mat-expansion-panel style="margin:10px;" *ngIf="sel_target.value=='file'">
    <mat-expansion-panel-header>Confidentialité</mat-expansion-panel-header>
    <mat-slide-toggle [(ngModel)]="encrypt_nft">Crypter les NFTs pour le fichier d'operations</mat-slide-toggle>
  </mat-expansion-panel>

</div>


  <div style="display: flex;flex-wrap: wrap;align-items: center;">


    <app-upload-file (uploaded)="onFileSelected($event)"
                     width="180px" [maxsize]="10000000"
                     extensions=".webp,.png,.gif,.jpeg,.jpg,.json">Charger des visuels
    </app-upload-file>


    <app-input [options]="network.config['PLATFORMS']"
               style="max-width: 170px;" *ngIf="user.advance_mode"
               label="Plateforme de stockage des visuel"
               [value]="sel_platform"
               (valueChange)="sel_platform=$event"></app-input>

    <app-input [options]="network.config['PLATFORMS']"
               style="max-width: 170px;" *ngIf="user.advance_mode"
               label="Plateforme de stockage des visuel"
               [value]="sel_platform_document"
               (valueChange)="sel_platform_document=$event"></app-input>

    <app-warning help="Le minage de NFT sur Elrond nécessite d'avoir choisi une collection"
                 [if]="network.isElrond() && !sel_collection"></app-warning>



    <button type="button" mat-icon-button
            title="Voir les collections disponibles"
            (click)="open_collections()">
      <mat-icon>visibility</mat-icon>
    </button>

    <button type="button" mat-icon-button
            title="Copier l'identifiant de la collection sélectionnée"
            *ngIf="sel_collection"
            [cdkCopyToClipboard]="sel_collection.id"
            (click)="informe_copy_collection()">
      <mat-icon>content_copy</mat-icon>
    </button>


    <app-input label="Cible"
               [value]="sel_target" style="max-width: 150px;"
               (valueChange)="sel_target=$event"
               [options]="targets"></app-input>

    <div *ngIf="sel_target.value=='blockchain'" style="margin-left: 20px;display: flex;align-items: center;">
      <app-input [value]="sel_network"
                 label="Sélectionnez une blockchain"
                 [options]="networks"
                 value_type="list" color="white"
                 (valueChange)="network.network=$event.value;network.init_keys($event.value);"></app-input>

      <app-input value_type="list" color="white"
                 *ngIf="network.keys.length>0"
                 label="Sélectionnez un compte"
                 [options]="network.keys" value_field="address"
                 [value]="sel_addr"
                 (valueChange)="sel_addr=$event;user.init(sel_addr,network.network);">
      </app-input>

      <app-input label="Collection utilisée" *ngIf="sel_addr.length>0"
                 [value]="sel_collection" style="max-width: 150px;"
                 (valueChange)="sel_collection=$event" value_type="list"
                 [options]="user.collections">
      </app-input>

    </div>




    <div *ngIf="tokens.length>0" style="display: flex;">
      <button type="button"
              mat-raised-button mat-button
              (click)="upload_all_tokens()">
        Upload visuel
      </button>

      <button type="button" [disabled]="user.key==undefined && network.network.indexOf('database')==-1"
              mat-raised-button mat-button
              (click)="confirm_mint()">
        Tout miner
      </button>

      <button type="button"
              mat-raised-button mat-button
              (click)="clear()">
        Effacer
      </button>


      <div *ngIf="user.advance_mode">
        <button type="button"
                mat-raised-button mat-button
                (click)="add_creator()">
          <mat-icon>add_circle</mat-icon>&nbsp;Créateur
        </button>

        <button type="button"
                mat-raised-button mat-button
                (click)="download_all()">
          Enregistrer
        </button>


        <button type="button" mat-raised-button mat-button
                title="Synchronize les paramètres sur l'operation sélectionnée"
                (click)="sync_on_ope()">
          Depuis l'opération
        </button>

      </div>

    </div>


  </div>


  <div *ngIf="content_for_clipboard.length>0">
    <h5>Copier ce texte pour l'insérer dans une opération</h5>
    <textarea style="margin-left: 10%;width: 90%;height: 400px;border: none;" class="mat-elevation-z2"
              (keydown)="clear_content_for_clipboard($event)">{{content_for_clipboard}}
    </textarea>
  </div>


  <br><br>

  <table style="padding: 5px;width:100%;text-align: center;" *ngIf="tokens.length>0">
    <tr class="mat-headline-6">
      <th>Visuel</th>
      <th>
        Titre /

        Description
        <mat-icon title="recopie les attributs du premier NFT sur les autres"
                  style="cursor: pointer;font-size: medium;"
                  (click)="clone_name()">refresh</mat-icon>

      </th>
      <th>
        Fichiers / Liens
      </th>
      <th>
        Price / Quantity
        <mat-icon title="recopie les attributs du premier NFT sur les autres"
                  style="cursor: pointer;font-size: medium;"
                  (click)="clone_marketplace()">refresh</mat-icon>

      </th>
      <th style="vertical-align: center;width: fit-content;">
        Attributs
        <mat-icon title="recopie les attributs du premier NFT sur les autres"
                  style="cursor: pointer;font-size: medium;"
                  (click)="clone_attribute()">refresh</mat-icon>
        <mat-icon title="Ajouter un attribut"
                  style="cursor: pointer;font-size: medium;"
                  (click)="add_attribute()">add_circle</mat-icon>
        <mat-icon title="Effacer les attributs"
                  style="cursor: pointer;font-size: medium;"
                  (click)="clear_attribute()">clear</mat-icon>
      </th>
      <th>Créateurs
        <mat-icon (click)="add_miner_to_creator()" style="cursor: pointer;font-size: medium;">add</mat-icon>
        <mat-icon (click)="reset_creator()" style="cursor: pointer;font-size: medium;">cancel</mat-icon>
      </th>
      <th>Commandes</th>

      <th style="min-width: 200px;">Message</th>
    </tr>
    <tr *ngFor="let token of tokens" style="margin: 5px;">
      <td style="width: fit-content">
        <div style="width: 100px;height: 100px;display: inline-block;" class="mat-elevation-z4">
          <a [href]="token.visual" target="_blank">
            <img [src]="token.visual"
                 [title]="token.visual"
                 alt="En cours de chargement ..." style="width: 100%;">
          </a>
        </div>
      </td>
      <td style="cursor: pointer;width: 300px;">
        <table>
          <tr>
            <td>Nom</td>
            <td><input matInput type="text" [(ngModel)]="token.name"></td>
          </tr>
          <tr>
            <td>Desc.</td>
            <td><textarea rows="2" col="40" matInput  [(ngModel)]="token.description"></textarea></td>
          </tr>
          <tr>
            <td>Tags</td>
            <td><input matInput type="text" [(ngModel)]="token.tags"></td>
          </tr>
          <tr *ngIf="!network.isElrond()">
            <td>Symbole</td>
            <td><input matInput type="text" [(ngModel)]="token.symbol"></td>
          </tr>
        </table>

      </td>

      <td style="max-width: 250px;text-align: left;overflow: hidden;" appFileDragNDrop (filesChangeEmiter)="drop($event,token)">
          <div *ngFor="let file of token.files" class="mat-body-1" style="margin:0;width: 100%;">
            <small style="display: flex;flex-wrap: nowrap;justify-content: left;">
              <mat-icon style="font-size: medium;display: inline;cursor: pointer;margin-left:3px;" (click)="delete_link(token,file)">cancel</mat-icon>
              <div (dblclick)="open_document(file)">
                <div *ngIf="file.indexOf('filename=')>0">{{file.split('filename=')[1]}}</div>
                <div *ngIf="file.indexOf('filename=')==-1">{{file}}</div>
              </div>

            </small>
          </div>
      </td>

      <td style="max-width: 50px;">
        <table>
          <tr>
            <td>Price</td>
            <td><input matInput type="number" style="max-width: 50px;text-align: right;" min="0" [(ngModel)]="token.marketplace!.price" ></td>
            <td>€</td>
          </tr>
          <tr>
            <td>Quantity</td>
            <td><input matInput type="number" style="max-width: 50px;text-align: right;"  min="0" [(ngModel)]="token.marketplace!.quantity" ></td>
          </tr>
          <tr>
            <td>
              Royalties
            </td>
            <td><input matInput type="number" style="max-width: 50px;text-align: right;"  min="0" max="100" [(ngModel)]="token.royalties" ></td>
            <td>
              %
              <app-warning help="En l'état les créateurs ne reçoivent aucune royalties"
                           [if]="token.creators.length>0 && token.royalties==0"></app-warning>
            </td>
          </tr>
        </table>

        <br>


      </td>

      <td style="text-align: left;">
        <ul>
          <li *ngFor="let a of token.attributes" (click)="edit_attribute(a)" style="cursor: pointer;">
            <strong *ngIf="a['trait_type'] && a['trait_type'].length>0">{{a['trait_type']}}:</strong> {{a.value}}
          </li>
        </ul>
      </td>


      <td style="text-align: left;width: min-content;">
        <div *ngFor="let creator of token.creators" class="mat-body-2">
          {{(creator.address | alias:network.network).substring(0,15)+(creator.address.length>15 ? '..' : '')}}&nbsp;({{creator?.share}}%)
        </div>
      </td>

      <td>
        <mat-icon style="cursor: pointer" (click)="upload_token(token)" title="upload du visuel" *ngIf="token.visual.startsWith('data')">upload</mat-icon>
        <mat-icon style="cursor: pointer" (click)="miner(token)"
                  title="minage du NFT"
                  *ngIf="user.key && !token.address">build</mat-icon>
        <mat-icon style="cursor: pointer" *ngIf="token.address && token.address.length>0"
                  (click)="see_in_hub(token)">
          visibility
        </mat-icon>
        <mat-icon style="cursor: pointer" (click)="remove(token)">delete</mat-icon>
        <app-upload-file title="Associer un fichier d'attributs"
                         (uploaded)="onUploadXMP($event,token)"
                         extensions=".xmp" icon="note"></app-upload-file>
      </td>

      <td style="width: 50px;" *ngIf="token.message">
        <app-hourglass *ngIf="token.message.startsWith('hourglass')" [message]="token.message.substring(10) || ''"></app-hourglass>
        <span *ngIf="!token.message.startsWith('hourglass')">{{token.message.substring(20)}}</span>
      </td>

    </tr>
  </table>



</div>
